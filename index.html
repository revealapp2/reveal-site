�", country: "Germany" },
      "it": { names: ["Giovanni","Marco","Luca"], cities:["Roma","Milano"], flag: "🇮🇹", country: "Italy" },
      "us": { names: ["James","John","Michael"], cities:["New York","Miami"], flag: "🇺🇸", country: "the USA" },
      "ru": { names: ["Dmitri","Ivan","Sergey"], cities:["Moscow","St. Petersburg"], flag: "🇷🇺", country: "Russia" },
      "br": { names: ["Paulo","Thiago","Lucas"], cities:["São Paulo","Rio de Janeiro"], flag: "🇧🇷", country: "Brasil" },
      "ph": { names: ["Juan", "Antonio", "Jose"], cities:["Manila", "Cebu"], flag: "🇵🇭", country: "the Philippines"}
    };

    const langToCountryMap = {
        'en': { country: 'the USA', flag: '🇺🇸' },
        'pt': { country: 'Brasil', flag: '🇧🇷' },
        'de': { country: 'Germany', flag: '🇩🇪' },
        'it': { country: 'Italy', flag: '🇮🇹' },
        'ru': { country: 'Russia', flag: '🇷🇺' },
        'ph': { country: 'the Philippines', flag: '🇵🇭' },
        'vi': { country: 'Vietnam', flag: '🇻🇳' },
        'zh-CN': { country: 'China', flag: '🇨🇳' },
        'tl': { country: 'the Philippines', flag: '🇵🇭' }
    };


    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'en,pt,zh-CN,vi,ru,tl', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false}, 'google_translate_element');
      new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'en,pt,zh-CN,vi,ru,tl', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false}, 'google_translate_element_mobile');
    }

    // --- Core Application Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- STATE ---
            purchaseState: {
                basePrice: 0,
                discount: 0,
                finalPrice: 0,
                email: null,
                username: null,
                platform: null,
                uniqueId: null,
                app: null,
                method: null,
            },
            
            // --- URGENCY & SCARCITY STATE ---
            urgencyState: {
                slotsLeft: 12,
                countdownInterval: null,
                paymentCountdownInterval: null,
                socialProofTimeout: null,
                exitIntentTriggered: false,
                isOfferExpired: false,
            },

            // --- DOM ELEMENTS ---
            dom: {
                currentYear: document.getElementById('current-year'),
                featuresGrid: document.getElementById('features-grid'),
                howItWorksGrid: document.getElementById('how-it-works-grid'),
                storyContainer: document.getElementById('story-container'),
                testimonialsContainer: document.getElementById('testimonials-container'),
                mobileMenu: document.getElementById('mobile-menu'),
                mobileMenuButton: document.getElementById('mobile-menu-button'),
                mobileMenuClose: document.getElementById('mobile-menu-close'),
                dialogContainer: document.getElementById('dialog-container'),
                mainContent: document.getElementById('main-content'),
                paymentConfirmationContent: document.getElementById('payment-confirmation-content'),
                startPurchaseBtn: document.getElementById('start-purchase-btn'),
                counterPlayers: document.getElementById('counter-players'),
                counterWinnings: document.getElementById('counter-winnings'),
                counterSatisfaction: document.getElementById('counter-satisfaction'),
                satisfactionBar: document.getElementById('satisfaction-bar-element'),
                // New Conversion Elements
                stickyBar: document.getElementById('sticky-bar'),
                stickyBarTextContainer: document.getElementById('sticky-bar-text-container'),
                mainHeader: document.getElementById('main-header'),
                countdownTimer: document.getElementById('countdown-timer'),
                slotsLeftHero: document.getElementById('slots-left-hero'),
                slotsLeftMid: document.getElementById('slots-left-mid'),
                slotsLeftMain: document.getElementById('slots-left-main'),
                socialProofContainer: document.getElementById('social-proof-container'),
                personalizationBanner: document.getElementById('personalization-banner'),
                urgencyTextContainer: document.getElementById('urgency-text-container'),
            },

            // --- METHODS ---
            
            // Initialization
            init() {
                this.dom.currentYear.textContent = new Date().getFullYear();
                this.initLanguage();
                this.initEventListeners();
                this.initStaticCounters();
                this.updateLiveCounters();
                this.initScrollAnimations();
                this.initUrgencyFeatures(); // Initialize all new features
                setInterval(() => this.updateLiveCounters(), 10000);
            },
            
            initEventListeners() {
                // Mobile Menu
                this.dom.mobileMenuButton.addEventListener('click', () => this.dom.mobileMenu.classList.replace('-translate-x-full', 'translate-x-0'));
                this.dom.mobileMenuClose.addEventListener('click', () => this.dom.mobileMenu.classList.replace('translate-x-0', '-translate-x-full'));
                document.querySelectorAll('#mobile-menu a').forEach(link => {
                    link.addEventListener('click', () => this.dom.mobileMenu.classList.replace('translate-x-0', '-translate-x-full'));
                });

                // Dialog
                this.dom.dialogContainer.addEventListener('click', (e) => {
                    if (e.target === this.dom.dialogContainer) this.closeDialog();
                });

                // Purchase Flow
                this.dom.startPurchaseBtn.addEventListener('click', () => this.startPurchaseFlow());
                document.querySelectorAll('a[href="#get-app"]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelector('#get-app').scrollIntoView({ behavior: 'smooth' });
                    });
                });

                // Exit Intent
                document.documentElement.addEventListener('mouseleave', (e) => {
                    if (e.clientY < 10 && !this.urgencyState.exitIntentTriggered) {
                        this.urgencyState.exitIntentTriggered = true;
                        this.showExitIntentPopup();
                    }
                });
            },

            initScrollAnimations() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            if (entry.target.id === 'counter-satisfaction') {
                                this.animateSatisfactionBar();
                            }
                            if (entry.target.classList.contains('hero')) {
                                this.dom.stickyBar.classList.add('hidden');
                                this.dom.mainHeader.style.top = '0';
                            }
                             if(!entry.target.classList.contains('hero')) {
                                observer.unobserve(entry.target);
                             }
                        } else {
                             if (entry.target.classList.contains('hero')) {
                                this.dom.stickyBar.classList.remove('hidden');
                                this.dom.mainHeader.style.top = `${this.dom.stickyBar.offsetHeight}px`;
                            }
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('.animate-on-scroll, .hero').forEach(el => {
                    observer.observe(el);
                });
            },

            // --- Urgency & Scarcity Features ---
            initUrgencyFeatures() {
                this.initializeDailySlots();
                setTimeout(() => this.showTimedPopup(), 45000); // 45s timed popup
                this.initializeCountdown();
                this.scheduleSocialProof();
            },

            initializeCountdown() {
                if (this.urgencyState.countdownInterval) {
                    clearInterval(this.urgencyState.countdownInterval);
                }
                
                const now = new Date().getTime();
                let offerEndTimeStr = localStorage.getItem('offerEndTime');
                let offerEndTime = offerEndTimeStr ? parseInt(offerEndTimeStr, 10) : 0;

                // If the stored end time is invalid or doesn't exist, set a new one.
                if (!offerEndTime || isNaN(offerEndTime)) {
                    offerEndTime = now + (4 * 3600 * 1000) + (23 * 60 * 1000) + (19 * 1000); // 4h 23m 19s
                    localStorage.setItem('offerEndTime', offerEndTime.toString());
                }

                const durationInSeconds = Math.round((offerEndTime - now) / 1000);

                if (durationInSeconds > 0) {
                    // Offer is active.
                    this.urgencyState.isOfferExpired = false;
                    if (this.dom.stickyBarTextContainer) {
                        this.dom.stickyBarTextContainer.innerHTML = this.getTranslatedString('stickyBarTextActive');
                    }
                    this.urgencyState.countdownInterval = this.startCountdown(durationInSeconds, this.dom.countdownTimer, () => {
                        this.urgencyState.isOfferExpired = true;
                        this.handleExpiredOffer();
                        this.showOfferExpiredPopup();
                    });
                } else {
                    // Offer has expired.
                    this.urgencyState.isOfferExpired = true;
                    this.handleExpiredOffer();
                }
            },

            startCountdown(duration, displayElement, onEndCallback) {
                let timer = duration;
                const intervalId = setInterval(() => {
                    if (timer <= 0) {
                        clearInterval(intervalId);
                        if(onEndCallback) onEndCallback();
                        return;
                    }

                    timer--;

                    let hours = parseInt(timer / 3600, 10);
                    let minutes = parseInt((timer % 3600) / 60, 10);
                    let seconds = parseInt(timer % 60, 10);

                    hours = hours < 10 ? "0" + hours : hours;
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    
                    if (displayElement) {
                        displayElement.textContent = hours + ":" + minutes + ":" + seconds;
                    }

                }, 1000);
                
                return intervalId;
            },

            handleExpiredOffer() {
                if (this.dom.stickyBarTextContainer) {
                    this.dom.stickyBarTextContainer.innerHTML = this.getTranslatedString('stickyBarTextExpired');
                }
                if (this.dom.countdownTimer) {
                    this.dom.countdownTimer.textContent = "";
                }
            },

            showOfferExpiredPopup() {
                const content = `
                    <div class="text-center">
                        <div class="text-5xl mb-4">⏳</div>
                        <h3 class="text-2xl font-bold mb-4">${this.getTranslatedString('offerExpiredTitle')}</h3>
                        <p class="text-gray-300 mb-6 text-lg">${this.getTranslatedString('offerExpiredText')}</p>
                        <button id="expired-offer-cta" class="cta-button font-bold py-3 px-6 rounded-lg">${this.getTranslatedString('offerExpiredButton')}</button>
                    </div>
                `;
                this.showDialog(content);
                document.getElementById('expired-offer-cta').onclick = () => {
                    this.closeDialog();
                    this.startPurchaseFlow();
                    setTimeout(() => {
                        const couponInput = document.getElementById('coupon-input');
                        if (couponInput) {
                            couponInput.value = '5OFF';
                            this.applyCoupon();
                        }
                    }, 500);
                };
            },

            initializeDailySlots() {
                const todayStr = new Date().toISOString().split('T')[0];
                let slotData = JSON.parse(localStorage.getItem('slotData'));

                if (!slotData || slotData.date !== todayStr) {
                    const daySeed = parseInt(todayStr.replace(/-/g, ''));
                    const initialSlots = Math.floor(this.seededRandom(daySeed) * (15 - 7 + 1)) + 7;
                    slotData = {
                        date: todayStr,
                        currentSlots: initialSlots,
                        lastHourlyCheck: new Date().getTime(),
                        extraSlotsAwarded: false
                    };
                } else {
                    const now = new Date().getTime();
                    const hoursPassed = Math.floor((now - slotData.lastHourlyCheck) / (1000 * 60 * 60));
                    if (hoursPassed > 0) {
                        slotData.currentSlots = Math.max(2, slotData.currentSlots - hoursPassed); // Don't go below 2
                        slotData.lastHourlyCheck = now;
                    }
                }
                
                localStorage.setItem('slotData', JSON.stringify(slotData));
                this.updateSlotsUI(slotData.currentSlots);
            },

            updateSlotsUI(slots) {
                const slotsElements = [this.dom.slotsLeftHero, this.dom.slotsLeftMid, this.dom.slotsLeftMain];
                slotsElements.forEach(el => {
                    if (el) {
                        el.textContent = slots;
                         const container = this.dom.urgencyTextContainer;
                         if (container) {
                            if (slots < 5) {
                                container.classList.add('text-red-600', 'animate-ping');
                                container.classList.remove('text-red-500');
                            } else {
                                 container.classList.remove('text-red-600', 'animate-ping');
                                 container.classList.add('text-red-500');
                            }
                         }
                    }
                });
            },
            
            showTimedPopup() {
                let slotData = JSON.parse(localStorage.getItem('slotData'));
                if (slotData && !slotData.extraSlotsAwarded) {
                    slotData.currentSlots += 2;
                    slotData.extraSlotsAwarded = true;
                    localStorage.setItem('slotData', JSON.stringify(slotData));
                    this.updateSlotsUI(slotData.currentSlots);

                    const content = `
                        <div class="text-center">
                            <div class="text-5xl mb-4">🎯</div>
                            <h3 class="text-2xl font-bold mb-2 text-yellow-400">${this.getTranslatedString('timedPopupTitle')}</h3>
                            <p class="text-gray-300 mb-6">${this.getTranslatedString('timedPopupText')}</p>
                            <a href="#get-app" id="timed-popup-cta" class="cta-button font-bold py-3 px-6 rounded-lg">${this.getTranslatedString('timedPopupButton')}</a>
                        </div>
                    `;
                    this.showDialog(content);
                    document.getElementById('timed-popup-cta').addEventListener('click', () => {
                        this.closeDialog();
                        document.querySelector('#get-app').scrollIntoView({ behavior: 'smooth' });
                    });
                }
            },

            showExitIntentPopup() {
                const content = `
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">${this.getTranslatedString('exitIntentTitle')}</h3>
                        <p class="text-gray-300 mb-6 text-lg">${this.getTranslatedString('exitIntentText')}</p>
                        <button id="exit-intent-cta" class="cta-button font-bold py-3 px-6 rounded-lg">${this.getTranslatedString('exitIntentButton')}</button>
                    </div>
                `;
                this.showDialog(content);
                document.getElementById('exit-intent-cta').onclick = () => {
                    this.closeDialog();
                    this.startPurchaseFlow();
                    setTimeout(() => {
                        const couponInput = document.getElementById('coupon-input');
                        if (couponInput && !this.urgencyState.isOfferExpired) {
                            couponInput.value = '10OFF';
                            this.applyCoupon();
                        }
                    }, 500);
                };
            },
            
            scheduleSocialProof() {
                const delay = Math.random() * (40000 - 20000) + 20000; // 20-40 seconds
                this.urgencyState.socialProofTimeout = setTimeout(() => {
                    this.showSocialProofNotification();
                    this.scheduleSocialProof();
                }, delay);
            },

            showSocialProofNotification() {
                const langKeys = Object.keys(socialProofData);
                const randomLangKey = langKeys[Math.floor(Math.random() * langKeys.length)];
                const data = socialProofData[randomLangKey];

                const name = data.names[Math.floor(Math.random() * data.names.length)];
                const location = data.cities[Math.floor(Math.random() * data.cities.length)];
                const app = ['PPPOKER', 'XPoker', 'ClubGG'][Math.floor(Math.random() * 3)];
                const actions = ['socialProofAcquired', 'socialProofGenerated', 'socialProofSeeing'];
                const actionKey = actions[Math.floor(Math.random() * actions.length)];

                const text = this.getTranslatedString(actionKey, {NAME: name, LOCATION: location, APP: app});

                const notification = document.createElement('div');
                notification.className = 'social-proof-notification bg-gray-800/90 backdrop-blur-sm border border-gray-700 rounded-lg p-4 shadow-lg flex items-center space-x-3 mb-3';
                notification.innerHTML = `<div>${data.flag} ${text}</div>`;

                this.dom.socialProofContainer.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, 5000);
            },


            // --- Counter Logic ---
            seededRandom(seed) {
                var m = 0x80000000;
                var a = 1103515245;
                var c = 12345;
                var state = seed;
                state = (a * state + c) % m;
                return state / (m - 1);
            },

            ensureNoRepeatingEndDigits(number) {
                const numStr = String(Math.round(number));
                if (numStr.length > 1 && numStr[numStr.length - 1] === numStr[numStr.length - 2]) {
                    return Math.round(number) + 1;
                }
                return Math.round(number);
            },
            
            initStaticCounters() {
                const today = new Date();
                const daySeed = parseInt(today.toISOString().split('T')[0].replace(/-/g, ''));

                const satisfaction = 98.50 + this.seededRandom(daySeed) * 0.5;
                if (this.dom.counterSatisfaction) {
                    this.dom.counterSatisfaction.textContent = `${satisfaction.toFixed(1)}%`;
                    this.dom.satisfactionBar.dataset.percent = satisfaction.toFixed(1);
                }

                const weeklyWinnings = 148000 + this.seededRandom(daySeed) * 25000;
                if (this.dom.counterWinnings) {
                    this.dom.counterWinnings.textContent = this.formatWinnings(weeklyWinnings);
                }
            },

            animateSatisfactionBar() {
                if (this.dom.satisfactionBar) {
                    const percent = this.dom.satisfactionBar.dataset.percent || 0;
                    this.dom.satisfactionBar.style.width = `${percent}%`;
                }
            },

            updateLiveCounters() {
                const today = new Date();
                const daySeed = parseInt(today.toISOString().split('T')[0].replace(/-/g, ''));
                const startOfDay = new Date(today.toISOString().split('T')[0]);
                const timePassed = today.getTime() - startOfDay.getTime();

                const MIN_PLAYERS = 1276;
                const MAX_PLAYERS = 1550;
                const twoMinuteIntervals = Math.floor(timePassed / (2 * 60 * 1000));
                const intervalSeed = daySeed + twoMinuteIntervals;
                let playerCount = MIN_PLAYERS + this.seededRandom(intervalSeed) * (MAX_PLAYERS - MIN_PLAYERS);
                const secondsIntoInterval = Math.floor((timePassed / 1000) % 120);

                if (secondsIntoInterval >= 60) {
                    const fluctuationSeed = intervalSeed * 3;
                    const change = this.seededRandom(fluctuationSeed) < 0.5 ? 20 : -27;
                    playerCount += change;
                }
                playerCount = Math.max(MIN_PLAYERS, Math.min(MAX_PLAYERS, playerCount));
                playerCount = this.ensureNoRepeatingEndDigits(playerCount);

                if (this.dom.counterPlayers) {
                    this.dom.counterPlayers.textContent = `+${playerCount.toLocaleString()}`;
                }
            },

            formatWinnings(amount) {
                if (amount >= 1000000) {
                    return `$${(amount / 1000000).toFixed(2)}M+`;
                } else if (amount >= 1000) {
                    return `$${Math.round(amount / 1000)}K+`;
                }
                return `$${amount}`;
            },

            // Language Handling
            initLanguage() {
                let userLang = localStorage.getItem("language");

                if (!userLang) {
                    const browserLang = (navigator.languages && navigator.languages[0]) || navigator.language;
                    const primaryLang = browserLang.split('-')[0];
                    userLang = translations[primaryLang] ? primaryLang : 'pt';
                }
                
                this.setLanguage(userLang);
            },

            setLanguage(lang) {
                localStorage.setItem("language", lang);
                document.documentElement.lang = lang;
                
                this.populateAllDynamicContent();
                this.showPersonalizationBanner();

                document.querySelectorAll("[data-translate]").forEach(el => {
                    const key = el.dataset.translate;
                    if (!key) return;

                    const translation = this.getTranslatedString(key);
                    
                    if (['storyText', 'storyCallToAction', 'exitIntentText', 'offerExpiredText', 'stickyBarTextActive', 'stickyBarTextExpired'].includes(key)) {
                         el.innerHTML = translation; 
                    } else {
                         el.textContent = translation;
                    }
                });
                document.title = this.getTranslatedString('pageTitle');
            },

            showPersonalizationBanner() {
                const lang = localStorage.getItem("language") || "pt";
                const countryData = langToCountryMap[lang] || langToCountryMap['en'];
                if (this.dom.personalizationBanner) {
                    this.dom.personalizationBanner.innerHTML = this.getTranslatedString('personalizationBanner', { COUNTRY: countryData.country, FLAG: countryData.flag });
                }
            },

            getTranslatedString(key, replacements = {}) {
                const lang = localStorage.getItem("language") || "pt";
                let translation = (translations[lang] && translations[lang][key]) ? translations[lang][key] : (translations['en'][key] || key);
                Object.entries(replacements).forEach(([placeholder, value]) => {
                    translation = translation.replace(`{${placeholder.toUpperCase()}}`, value);
                });
                return translation;
            },
            
            // Dynamic Content Population
            populateAllDynamicContent() {
                this.populateFeatures();
                this.populateHowItWorks();
                this.populateStory();
                this.populateTestimonials();
            },

            populateFeatures() {
                const container = this.dom.featuresGrid;
                if(!container) return;
                const featureKeys = [
                    { key: 'feature1', icon: 'fa-eye' },
                    { key: 'feature2', icon: 'fa-mobile-alt' },
                    { key: 'feature3', icon: 'fa-shield-alt' },
                    { key: 'feature4', icon: 'fa-chart-line' },
                    { key: 'feature5', icon: 'fa-sync' },
                    { key: 'feature6', icon: 'fa-headset' },
                ];
                container.innerHTML = featureKeys.map(({key, icon}, index) => `
                    <div class="feature-card animate-on-scroll" style="transition-delay: ${index * 100}ms;">
                        <div class="text-4xl text-yellow-400 mb-4"><i class="fas ${icon}"></i></div>
                        <h3 class="text-xl font-bold mb-2">${this.getTranslatedString(`${key}Title`)}</h3>
                        <p class="text-gray-400">${this.getTranslatedString(`${key}Text`)}</p>
                    </div>
                `).join('');
            },
            
            populateHowItWorks() {
                 const container = this.dom.howItWorksGrid;
                 if(!container) return;
                 container.innerHTML = [1, 2, 3, 4].map((i, index) => `
                    <div class="text-center animate-on-scroll" style="transition-delay: ${index * 150}ms;">
                        <div class="relative mb-4">
                             <div class="w-24 h-24 bg-gray-700 rounded-full mx-auto flex items-center justify-center text-4xl font-bold text-yellow-400 border-2 border-gray-600">${i}</div>
                            ${i < 4 ? '<div class="absolute top-1/2 left-full w-full h-0.5 bg-gray-700 hidden md:block" style="transform: translateY(-50%);"></div>' : ''}
                        </div>
                        <h3 class="text-xl font-bold mt-4 mb-2">${this.getTranslatedString(`step${i}Title`)}</h3>
                        <p class="text-gray-400">${this.getTranslatedString(`step${i}Text`)}</p>
                    </div>
                `).join('');
            },

            populateStory() {
                const container = this.dom.storyContainer;
                if (!container) return;
                container.innerHTML = `
                    <p class="text-lg text-gray-300 mb-6">${this.getTranslatedString('storyText')}</p>
                    <p class="text-xl text-yellow-400 font-semibold">${this.getTranslatedString('storyCallToAction')}</p>
                `;
            },
            
            populateTestimonials() {
                 const container = this.dom.testimonialsContainer;
                 if(!container) return;
                 const testimonialsData = [
                    { key: 1, flag: "🇺🇸" },
                    { key: 2, flag: "🇧🇷" },
                    { key: 3, flag: "🇪🇺" },
                    { key: 4, flag: "🇯🇵" },
                    { key: 5, flag: "🇷🇺" },
                 ];
                 container.innerHTML = testimonialsData.map(({key, flag}, index) => `
                    <div class="testimonial-card animate-on-scroll" style="transition-delay: ${index * 100}ms;">
                        <i class="fas fa-quote-left text-yellow-400 text-2xl mb-4"></i>
                        <p class="text-gray-400 mb-4">${this.getTranslatedString(`testimonial${key}Quote`)}</p>
                        <div class="flex items-center">
                            <img src="https://placehold.co/40x40/1f2937/ffffff?text=${this.getTranslatedString(`testimonial${key}Author`)[0]}" class="w-10 h-10 rounded-full mr-4" alt="User photo">
                            <div>
                                <p class="font-semibold">${this.getTranslatedString(`testimonial${key}Author`)}</p>
                                <p class="text-sm text-gray-400">${flag}</p>
                            </div>
                        </div>
                    </div>
                  `).join('');
            },

            // --- Dialog Management ---
            showDialog(content) {
                this.dom.dialogContainer.innerHTML = `<div class="dialog-content w-full max-w-md p-6 rounded-lg animate-on-scroll is-visible">${content}</div>`;
                this.dom.dialogContainer.classList.remove('hidden');
            },

            closeDialog() {
                this.dom.dialogContainer.classList.add('hidden');
                this.dom.dialogContainer.innerHTML = '';
            },
            
            // --- Purchase Flow & Page Transitions ---
            startPurchaseFlow() {
                const email = localStorage.getItem("userEmail");
                const username = localStorage.getItem("username");
                if (email && username) {
                    this.purchaseState.email = email;
                    this.purchaseState.username = username;
                    this.showPlatformDialog();
                } else {
                    this.showRegistrationDialog();
                }
            },

            showRegistrationDialog() {
                const content = `
                    <h3 class="text-xl font-bold mb-4 text-center">${this.getTranslatedString('registerTitle')}</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="email-input" class="block mb-2 text-sm font-medium">${this.getTranslatedString('emailLabel')}</label>
                            <input type="email" id="email-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="${this.getTranslatedString('emailPlaceholder')}" required>
                             <p id="email-validation-message" class="text-red-500 text-sm mt-1 h-4"></p>
                        </div>
                        <div>
                            <label for="username-input" class="block mb-2 text-sm font-medium">${this.getTranslatedString('usernameLabel')}</label>
                            <input type="text" id="username-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="${this.getTranslatedString('usernamePlaceholder')}" required>
                            <p id="username-validation-message" class="text-red-500 text-sm mt-1 h-4"></p>
                        </div>
                        <button id="submit-registration-btn" class="w-full cta-button font-bold py-2.5 px-5 rounded-lg">${this.getTranslatedString('registerButton')}</button>
                    </div>
                `;
                this.showDialog(content);
                document.getElementById('submit-registration-btn').onclick = () => this.submitRegistration();
            },
            
            submitRegistration() {
                const emailInput = document.getElementById("email-input");
                const usernameInput = document.getElementById("username-input");
                const emailError = document.getElementById("email-validation-message");
                const usernameError = document.getElementById("username-validation-message");
                
                let isValid = true;
                
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
                    emailError.textContent = this.getTranslatedString('emailValidationError');
                    isValid = false;
                } else {
                    emailError.textContent = '';
                }

                if (usernameInput.value.length < 3) {
                    usernameError.textContent = this.getTranslatedString('usernameValidationError');
                    isValid = false;
                } else {
                    usernameError.textContent = '';
                }

                if(isValid) {
                    localStorage.setItem("userEmail", emailInput.value);
                    localStorage.setItem("username", usernameInput.value);
                    this.purchaseState.email = emailInput.value;
                    this.purchaseState.username = usernameInput.value;
                    this.showPlatformDialog();
                }
            },

            showPlatformDialog() {
                const content = `
                    <h3 class="text-xl font-bold mb-4 text-center">${this.getTranslatedString('platformDialogTitle')}</h3>
                    <p class="text-center text-gray-400 mb-6">${this.getTranslatedString('platformDialogText')}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="select-android" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition"><i class="fab fa-android mr-2"></i><span>${this.getTranslatedString('platformAndroid')}</span></button>
                        <button id="select-ios" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition"><i class="fab fa-apple mr-2"></i><span>${this.getTranslatedString('platformIOS')}</span></button>
                    </div>
                `;
                this.showDialog(content);
                document.getElementById('select-android').onclick = () => this.selectPlatform('Android');
                document.getElementById('select-ios').onclick = () => this.selectPlatform('iOS');
            },
            
            selectPlatform(platform) {
                this.purchaseState.platform = platform;
                this.showUniqueIdDialog();
            },

            showUniqueIdDialog() {
                let uniqueId = localStorage.getItem("uniqueId");
                if (!uniqueId) {
                    uniqueId = Date.now().toString().slice(-9);
                    localStorage.setItem("uniqueId", uniqueId);
                }
                this.purchaseState.uniqueId = uniqueId;

                const content = `
                    <h3 class="text-xl font-bold mb-4 text-center">${this.getTranslatedString('uniqueIdDialogTitle')}</h3>
                    <p class="text-center text-gray-400 mb-4">${this.getTranslatedString('uniqueIdDialogText')}</p>
                    <div class="flex items-center bg-gray-800 p-3 rounded-lg">
                        <span id="unique-id-value" class="flex-grow text-lg font-mono">${uniqueId}</span>
                        <button id="copy-id-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg ml-4"><i class="fas fa-copy"></i></button>
                    </div>
                    <button id="continue-to-poker-app" class="mt-6 w-full cta-button font-bold py-2.5 px-5 rounded-lg">${this.getTranslatedString('continueButton')}</button>
                `;
                this.showDialog(content);
                document.getElementById('copy-id-btn').onclick = () => this.copyToClipboard(uniqueId, true);
                document.getElementById('continue-to-poker-app').onclick = () => this.showPokerAppDialog();
            },

            showPokerAppDialog() {
                const content = `
                    <h3 class="text-xl font-bold mb-4 text-center">${this.getTranslatedString('pokerAppDialogTitle')}</h3>
                     <p class="text-center text-gray-400 mb-6">${this.getTranslatedString('pokerAppDialogText')}</p>
                     <div id="personalization-message" class="hidden text-center text-green-400 mb-6 font-semibold"></div>
                    <div class="space-y-3">
                        <button id="select-pppoker" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition">PPPOKER</button>
                        <button id="select-xpoker" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">XPoker</button>
                        <button id="select-clubgg" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">ClubGG</button>
                    </div>
                `;
                this.showDialog(content);
                document.getElementById('select-pppoker').onclick = () => this.selectPokerApp('PPPOKER');
                document.getElementById('select-xpoker').onclick = () => this.selectPokerApp('XPoker');
                document.getElementById('select-clubgg').onclick = () => this.selectPokerApp('ClubGG');
            },

            selectPokerApp(app) {
                this.purchaseState.app = app;
                const prices = { PPPOKER: 1500, XPoker: 1500, ClubGG: 4000 };
                this.purchaseState.basePrice = prices[app] || 0;
                this.purchaseState.discount = 0; // Reset discount
                this.showCouponDialog();
            },

            showCouponDialog() {
                const finalPrice = this.purchaseState.basePrice * (1 - this.purchaseState.discount);
                const personalizationMessage = this.getTranslatedString('personalizationText', {APP: this.purchaseState.app, PLATFORM: this.purchaseState.platform});

                const content = `
                    <h3 class="text-xl font-bold mb-4 text-center">${this.getTranslatedString('couponDialogTitle')}</h3>
                    <p class="text-center text-green-400 mb-4 font-semibold">${personalizationMessage}</p>
                    <div class="text-center mb-4">
                         <p id="original-price-container" class="${this.purchaseState.discount > 0 ? '' : 'hidden'} text-gray-500">
                             <span>${this.getTranslatedString('originalAmountLabel')}</span>:
                             <s id="original-price-value">$${this.purchaseState.basePrice.toFixed(2)}</s>
                         </p>
                        <p id="final-price-display" class="text-2xl font-bold text-yellow-400">${this.getTranslatedString('amountTextBase', { PRICE: `$${finalPrice.toFixed(2)}`})}</p>
                    </div>
                    <p class="text-center text-gray-400 mb-4">${this.getTranslatedString('couponDialogText')}</p>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="coupon-input" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5" placeholder="${this.getTranslatedString('couponPlaceholder')}">
                        <button id="apply-coupon-btn" class="cta-button font-bold py-2.5 px-5 rounded-lg">${this.getTranslatedString('applyCouponButton')}</button>
                    </div>
                    <p id="coupon-message" class="text-center h-5 mt-2 text-sm"></p>
                    <button id="proceed-to-payment-method" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-5 rounded-lg">${this.getTranslatedString('proceedButton')}</button>
                `;
                this.showDialog(content);
                document.getElementById('apply-coupon-btn').onclick = () => this.applyCoupon();
                document.getElementById('proceed-to-payment-method').onclick = () => this.proceedToPaymentMethod();
            },

            applyCoupon() {
                const couponInput = document.getElementById('coupon-input');
                const messageEl = document.getElementById('coupon-message');
                if(!couponInput || !messageEl) return;
                const code = couponInput.value.trim().toUpperCase();
                
                let discount = 0;
                let isValid = false;

                if (code === 'QWERTY') {
                    discount = 0.30;
                    isValid = true;
                } else if (code === '10OFF') {
                    if (this.urgencyState.isOfferExpired) {
                        isValid = false;
                    } else {
                        discount = 0.10;
                        isValid = true;
                    }
                } else if (code === '5OFF') {
                    discount = 0.05;
                    isValid = true;
                }
                
                this.purchaseState.discount = isValid ? discount : 0;
                
                if (isValid) {
                    messageEl.textContent = this.getTranslatedString('couponAppliedSuccess', { COUPON_CODE: code, DISCOUNT: (discount * 100) });
                    messageEl.className = 'text-center h-5 mt-2 text-sm text-green-400';
                } else {
                     messageEl.textContent = this.getTranslatedString('couponErrorInvalid');
                                   messageEl.className = 'text-center h-5 mt-2 text-sm text-red-400';
                }

                const finalPrice = this.purchaseState.basePrice * (1 - this.purchaseState.discount);
                const originalPriceContainer = document.getElementById('original-price-container');
                const finalPriceDisplay = document.getElementById('final-price-display');

                if (finalPriceDisplay) {
                     finalPriceDisplay.textContent = this.getTranslatedString('amountTextBase', { PRICE: `$${finalPrice.toFixed(2)}`});
                }

                if (originalPriceContainer) {
                    const originalPriceValueEl = originalPriceContainer.querySelector('s');
                     if (this.purchaseState.discount > 0) {
                         if(originalPriceValueEl) originalPriceValueEl.textContent = `$${this.purchaseState.basePrice.toFixed(2)}`;
                         originalPriceContainer.classList.remove('hidden');
                     } else {
                         originalPriceContainer.classList.add('hidden');
                     }
                }
            },
            
            proceedToPaymentMethod() {
                this.purchaseState.finalPrice = this.purchaseState.basePrice * (1 - this.purchaseState.discount);
                this.showPaymentMethodDialog();
            },

            showPaymentMethodDialog() {
                const content = `
                    <h3 class="text-xl font-bold mb-4 text-center">${this.getTranslatedString('paymentMethodDialogTitle')}</h3>
                    <p class="text-center text-gray-400 mb-6">${this.getTranslatedString('paymentMethodDialogText')}</p>
                    <div class="space-y-3">
                        <button id="pay-usdt" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">USDT (TRC20)</button>
                        <button id="pay-btc" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition">BTC</button>
                        <button id="pay-eth" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition">ETH</button>
                    </div>
                `;
                this.showDialog(content);
                document.getElementById('pay-usdt').onclick = () => this.selectPaymentMethod('usdt');
                document.getElementById('pay-btc').onclick = () => this.selectPaymentMethod('btc');
                document.getElementById('pay-eth').onclick = () => this.selectPaymentMethod('eth');
            },

            async selectPaymentMethod(method) {
                this.purchaseState.method = method;
                await this.showPaymentDetailsDialog();
            },

            async getCryptoPrice(cryptoId) {
                try {
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${cryptoId}&vs_currencies=usd`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const data = await response.json();
                    return data[cryptoId].usd;
                } catch (error) {
                    console.error("Failed to fetch crypto price:", error);
                    return null;
                }
            },

            async showPaymentDetailsDialog() {
                const { method, finalPrice } = this.purchaseState;
                
                const addresses = {
                    usdt: "TXxRAVZP8fUJVm2yMTS8uei2AsgKtLviuK",
                    btc: "bc1q983fl9ehgw88wqgs2k78vurrk2l2z6t6afphz3",
                    eth: "0x9b5877A847BE203FCbA421194C83E0af6f686cC7"
                };
                const networks = { usdt: "TRC20", btc: "Bitcoin", eth: "Ethereum" };
                const cryptoIds = { btc: 'bitcoin', eth: 'ethereum' };

                const address = addresses[method];
                const network = networks[method];
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${address}`;
                
                let cryptoAmountHTML = `<p class="text-3xl font-bold text-yellow-400">$${finalPrice.toFixed(2)}</p>`;
                if (method !== 'usdt') {
                    cryptoAmountHTML = `<div class="h-8 flex items-center justify-center"><div class="spinner"></div><span class="ml-2">${this.getTranslatedString('loadingPaymentText')}</span></div>`;
                }

                const content = `
                    <h3 class="text-xl font-bold mb-2 text-center">${this.getTranslatedString('paymentDialogTitleFinal')}</h3>
                    <p class="text-center text-gray-400 mb-6">${this.getTranslatedString('paymentInstructionsText')}</p>
                    
                    <div id="payment-amount-container" class="text-center mb-4">
                        ${cryptoAmountHTML}
                    </div>
                    
                    <div class="flex justify-center mb-4">
                        <div class="p-2 bg-white rounded-lg border-4 border-gray-600">
                            <img src="${qrUrl}" alt="${method.toUpperCase()} QR Code">
                        </div>
                    </div>
                    
                    <div class="flex items-center bg-gray-800 p-2 rounded-lg">
                        <input id="wallet-address-input" type="text" class="flex-grow bg-transparent text-sm text-gray-300 border-0 focus:ring-0" value="${address}" readonly>
                        <button id="copy-address-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg ml-2">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p id="copy-feedback-dialog" class="text-green-400 text-sm mt-2 h-4 text-center"></p>

                    <p class="text-xs text-gray-500 text-center mt-4">${this.getTranslatedString('paymentInstructionsSecurity')}</p>

                    <button id="payment-done-btn" class="mt-6 w-full cta-button font-bold py-3 px-5 rounded-lg">${this.getTranslatedString('paymentDoneButton')}</button>
                `;
                this.showDialog(content);
                document.getElementById('copy-address-btn').onclick = () => this.copyToClipboard(address, true);
                document.getElementById('payment-done-btn').onclick = () => this.proceedToFinalConfirmation();

                // Start payment timer
                if(this.urgencyState.paymentCountdownInterval) clearInterval(this.urgencyState.paymentCountdownInterval);
                const paymentTimerEl = document.getElementById('payment-timer');
                this.urgencyState.paymentCountdownInterval = this.startCountdown(30 * 60, paymentTimerEl, () => {
                    if(paymentTimerEl) paymentTimerEl.textContent = "Expired";
                    this.closeDialog();
                });

                if (method !== 'usdt') {
                    const cryptoPrice = await this.getCryptoPrice(cryptoIds[method]);
                    const paymentAmountContainer = document.getElementById('payment-amount-container');
                    if (cryptoPrice) {
                        const cryptoAmount = (finalPrice / cryptoPrice).toFixed(8);
                        paymentAmountContainer.innerHTML = `
                            <p class="text-sm text-gray-400">${this.getTranslatedString('amountToSendLabel')} $${finalPrice.toFixed(2)}</p>
                            <p class="text-2xl font-bold text-yellow-400">${cryptoAmount} ${method.toUpperCase()}</p>
                            <p class="text-sm text-gray-500"><span>${this.getTranslatedString('networkLabel')}</span>: ${network}</p>
                        `;
                    } else {
                        paymentAmountContainer.innerHTML = `<p class="text-red-400">Could not fetch crypto price. Please try again.</p>`;
                    }
                }
            },
            
            copyToClipboard(text, isDialog = false) {
                navigator.clipboard.writeText(text).then(() => {
                    const feedbackId = isDialog ? 'copy-feedback-dialog' : 'copy-feedback';
                    const feedbackEl = document.getElementById(feedbackId);
                    if(feedbackEl) {
                        feedbackEl.textContent = this.getTranslatedString('copiedText');
                        setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
                    }
                });
            },

            proceedToFinalConfirmation() {
                this.closeDialog();
                this.showPaymentConfirmationPage();
            },

            showPaymentConfirmationPage() {
                this.dom.mainContent.classList.add('hidden');
                const confirmationContainer = this.dom.paymentConfirmationContent;
                
                const uniqueId = this.purchaseState.uniqueId || localStorage.getItem('uniqueId');
                const platform = this.purchaseState.platform || 'Not specified';
                const app = this.purchaseState.app || 'Not specified';

                // Construct the message in English
                const telegramMessage = `ID: ${uniqueId}\nPlatform: ${platform}\nApp: ${app}`;
                const encodedTelegramMessage = encodeURIComponent(telegramMessage);
                const telegramUrl = `https://t.me/bedmalcon_temp?text=${encodedTelegramMessage}`;

                
                confirmationContainer.innerHTML = `
                    <section class="min-h-screen py-16 md:py-24 flex items-center">
                        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="max-w-2xl mx-auto bg-gray-800/50 p-6 md:p-8 rounded-lg shadow-xl text-center">
                                <div class="text-6xl text-green-400 mb-4">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3 class="text-2xl font-bold mb-4">${this.getTranslatedString('telegramInstructionsTitle')}</h3>
                                <p class="text-gray-400 mb-6">${this.getTranslatedString('telegramInstructionsText')}</p>
                                
                                <div class="flex items-center bg-gray-900 p-3 rounded-lg max-w-sm mx-auto">
                                    <span class="flex-grow text-lg font-mono text-yellow-400">${uniqueId}</span>
                                    <button id="copy-id-button-confirm" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg ml-4">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <p id="copy-feedback" class="text-green-400 text-sm mt-2 h-4"></p>
                                
                                <div class="mt-8 bg-gray-900/50 p-6 rounded-lg text-left max-w-md mx-auto">
                                     <div class="space-y-4">
                                         <div>
                                             <h4 class="font-semibold">${this.getTranslatedString('telegramStep1Title')}</h4>
                                             <p class="text-sm text-gray-400">${this.getTranslatedString('telegramStep1Desc')}</p>
                                         </div>
                                         <div>
                                             <h4 class="font-semibold">${this.getTranslatedString('telegramStep2Title')}</h4>
                                             <p class="text-sm text-gray-400">${this.getTranslatedString('telegramStep2Desc')}</p>
                                         </div>
                                         <div>
                                             <h4 class="font-semibold">${this.getTranslatedString('telegramStep3Title')}</h4>
                                             <p class="text-sm text-gray-400">${this.getTranslatedString('telegramStep3Desc')}</p>
                                         </div>
                                     </div>
                                </div>

                                <a href="${telegramUrl}" target="_blank" class="inline-block mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition text-lg">
                                    <i class="fab fa-telegram-plane mr-2"></i>
                                    <span>${this.getTranslatedString('openTelegramButton')}</span>
                                </a>
                            </div>
                        </div>
                    </section>
                `;
                
                confirmationContainer.classList.remove('hidden');

                document.getElementById('copy-id-button-confirm').onclick = () => this.copyToClipboard(uniqueId, false);
                
                window.scrollTo(0, 0);
            },
        };

        // --- GLOBALIZED METHODS FOR HTML ONCLICK ---
        window.setLanguage = App.setLanguage.bind(App);

        // --- INITIALIZE THE APP ---
        App.init();
    });
    </script>
    
    <!-- Code Protection Script -->
    <script>
        // This script attempts to deter users from opening developer tools.
        // Note: This is not a foolproof method, but can discourage casual inspection.

        // 1. Disable right-click context menu
        document.addEventListener('contextmenu', event => event.preventDefault());

        // 2. Disable common DevTools keyboard shortcuts
        document.addEventListener('keydown', event => {
            // F12
            if (event.keyCode === 123) {
                event.preventDefault();
            }
            // Ctrl+Shift+I
            if (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'i')) {
                event.preventDefault();
            }
            // Ctrl+Shift+J
            if (event.ctrlKey && event.shiftKey && (event.key === 'J' || event.key === 'j')) {
                event.preventDefault();
            }
            // Ctrl+U
            if (event.ctrlKey && (event.key === 'U' || event.key === 'u')) {
                event.preventDefault();
            }
        });
    </script>
</body>
</html>
